<!-- Store research data for email regeneration -->
<script>
    var researchData = {{ result_json | safe }};
</script>

<div class="fade-in">

    <!-- Score Banner -->
    <div class="rounded-xl overflow-hidden mb-6
        {% if result.score >= 80 %}
            score-hot
        {% elif result.score >= 60 %}
            score-good
        {% elif result.score >= 40 %}
            score-marginal
        {% else %}
            score-low
        {% endif %}
    ">
        <div class="px-6 py-4 flex items-center justify-between">
            <div>
                <h3 class="text-white font-semibold text-lg">Hallazgos SMTYKM</h3>
                <span class="text-white/80 text-sm">
                    {% if result.score >= 80 %}
                        &#128293; Oportunidad caliente
                    {% elif result.score >= 60 %}
                        &#9989; Buena oportunidad
                    {% elif result.score >= 40 %}
                        &#9888;&#65039; Oportunidad marginal
                    {% else %}
                        &#10060; Sin datos suficientes
                    {% endif %}
                    &middot; Tipo
                    <span class="bg-white/20 text-white text-xs font-bold px-2 py-0.5 rounded ml-1">{{ result.hallazgo_tipo }}</span>
                    {% if result.hallazgo_tipo == 'A' %}
                        Noticia de la empresa
                    {% elif result.hallazgo_tipo == 'B' %}
                        Logro del ejecutivo
                    {% elif result.hallazgo_tipo == 'C' %}
                        Tendencia de la industria
                    {% elif result.hallazgo_tipo == 'D' %}
                        Informacion general
                    {% endif %}
                    &middot; LLM: {{ result.llm_used }}
                </span>
            </div>
            <div class="bg-white/20 rounded-full px-4 py-2">
                <span class="text-white font-bold text-2xl">{{ result.score }}<span class="text-sm font-normal">/100</span></span>
            </div>
        </div>
        {% if result.hallazgos %}
        <div class="bg-black/10 px-6 py-3">
            <div class="space-y-3">
                {% for h in result.hallazgos %}
                <div>
                    <div class="flex items-start gap-2 text-white/90 text-sm">
                        <span class="mt-0.5 shrink-0">
                            {% if h.get('confidence') == 'verified' %}&#9989;{% elif h.get('confidence') == 'unverified' %}&#128308;{% else %}&#9888;&#65039;{% endif %}
                        </span>
                        <span>{{ h.get('content', '') }}</span>
                    </div>
                    <div class="ml-6 mt-1 text-white/50 text-xs">
                        {% if h.get('sources') and h.sources | length > 0 %}
                            {% for src_url in h.sources[:3] %}
                                <a href="{{ src_url }}" target="_blank" rel="noopener" class="hover:text-white/70 underline">{{ src_url | truncate(50) }}</a>{% if not loop.last %} | {% endif %}
                            {% endfor %}
                        {% else %}
                            Fuente: Conocimiento general del LLM (no verificado)
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Warning banner when no scraping data -->
    {% if 'sin verificar' in result.llm_used or not result.raw_sources %}
    <div class="rounded-xl bg-amber-50 border border-amber-300 px-5 py-3 mb-6 flex items-start gap-3">
        <span class="text-amber-600 text-xl mt-0.5 shrink-0">&#9888;&#65039;</span>
        <div>
            <p class="text-amber-800 font-medium text-sm">Resultados basados en conocimiento general de IA</p>
            <p class="text-amber-700 text-xs mt-0.5">No se encontraron fuentes publicas verificables. Los datos mostrados no han sido verificados y pueden ser inexactos. Usar con precaucion.</p>
        </div>
    </div>
    {% endif %}

    <!-- Three Column Layout: Personal (left) | Email (center) | Empresa (right) -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">

        <!-- LEFT COLUMN: Info Personal -->
        <div class="lg:col-span-3 space-y-4">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-faymex-dark px-5 py-3">
                    <h3 class="text-white font-medium">&#128100; Info Personal</h3>
                </div>
                <div class="p-5 space-y-3">
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Nombre</span>
                        <p class="font-semibold text-faymex-dark text-base">{{ result.persona.get('nombre_completo', result.persona.get('nombre', name)) }}</p>
                    </div>
                    {% if result.linkedin_search_url %}
                    <div>
                        <a href="{{ result.linkedin_search_url }}" target="_blank" rel="noopener"
                           class="text-blue-600 hover:underline text-sm flex items-center gap-1">
                            &#128279; Buscar en LinkedIn
                        </a>
                    </div>
                    {% endif %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Cargo</span>
                        <div class="flex items-center gap-1.5">
                            <p class="font-medium text-sm">{{ result.cargo_descubierto or result.persona.get('cargo_actual', result.persona.get('cargo', 'No encontrado')) }}</p>
                            {% if result.raw_sources and (result.cargo_descubierto or result.persona.get('cargo_actual') or result.persona.get('cargo')) %}
                                <span class="badge-verified" title="Verificado con fuentes">&#9989;</span>
                            {% else %}
                                <span class="badge-partial" title="No verificado">&#9888;&#65039;</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if result.persona.get('empresa') or result.persona.get('empresa_actual') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Empresa</span>
                        <p class="font-medium text-sm">{{ result.persona.get('empresa_actual', result.persona.get('empresa', '')) }}</p>
                    </div>
                    {% endif %}
                    {% if result.persona.get('trayectoria') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Trayectoria</span>
                        <p class="text-gray-700 text-sm leading-relaxed">{{ result.persona.trayectoria }}</p>
                    </div>
                    {% endif %}
                    {% if result.persona.get('educacion') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Educacion</span>
                        <p class="text-gray-700 text-sm">{{ result.persona.educacion }}</p>
                    </div>
                    {% endif %}
                    {% if result.persona.get('ubicacion') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Ubicacion</span>
                        <p class="text-gray-700 text-sm">{{ result.persona.ubicacion }}</p>
                    </div>
                    {% endif %}
                    {% if result.persona.get('intereses') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Intereses</span>
                        <p class="text-gray-700 text-sm">{{ result.persona.intereses }}</p>
                    </div>
                    {% endif %}
                    {% if result.persona.get('logros_recientes') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Logros recientes</span>
                        {% if result.persona.logros_recientes is string %}
                            <p class="text-gray-700 text-sm">{{ result.persona.logros_recientes }}</p>
                        {% else %}
                            {% for logro in result.persona.logros_recientes %}
                            <p class="text-gray-700 text-sm">&#8226; {{ logro }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if result.persona.get('experiencia_previa') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Experiencia previa</span>
                        {% if result.persona.experiencia_previa is string %}
                            <p class="text-gray-700 text-sm">{{ result.persona.experiencia_previa }}</p>
                        {% else %}
                            {% for exp in result.persona.experiencia_previa %}
                            <p class="text-gray-700 text-sm">&#8226; {{ exp }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% set persona_sources = result.raw_sources | selectattr('source', 'in', ['linkedin', 'perplexity_persona', 'duckduckgo']) | list %}
            {% if persona_sources %}
            <details class="text-sm bg-white rounded-xl shadow-sm overflow-hidden">
                <summary class="px-5 py-3 text-gray-400 cursor-pointer hover:text-gray-600 font-medium">
                    &#128100; {{ persona_sources | length }} fuentes personales
                </summary>
                <div class="px-5 pb-3 space-y-1">
                    {% for src in persona_sources[:5] %}
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <span class="w-20 text-gray-400 shrink-0 text-xs">{{ src.get('source', '') }}</span>
                        <a href="{{ src.get('url', '#') }}" target="_blank" rel="noopener"
                           class="text-blue-500 hover:underline truncate">
                            {{ src.get('title', src.get('url', '')) | truncate(40) }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>

        <!-- CENTER COLUMN: Email Editor -->
        <div class="lg:col-span-6">
            <div id="email-area">
                {% if email %}
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-faymex-dark to-gray-800 px-5 py-3">
                        <h2 class="text-white font-semibold">&#128231; Email SMTYKM</h2>
                    </div>
                    <div class="p-5">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Asunto</label>
                            <div class="relative">
                                <input type="text" id="email-subject"
                                       value="{{ email.subject }}"
                                       maxlength="80"
                                       oninput="updateSubjectCounter(this)"
                                       class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 text-base font-medium focus:ring-2 focus:ring-faymex-red focus:border-faymex-red outline-none pr-16">
                                <span id="subject-counter"
                                      class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400">
                                    {{ email.subject | length }}/40
                                </span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cuerpo del email</label>
                            <div id="quill-editor" class="quill-container"></div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-500 mb-4 border-t border-gray-100 pt-3">
                            <span id="word-count">Palabras: 0</span>
                            <span id="email-validity" class="flex items-center gap-1"></span>
                        </div>

                        {% if email.reasoning %}
                        <details class="mb-4 text-sm border border-gray-100 rounded-lg">
                            <summary class="px-3 py-2 text-gray-400 cursor-pointer hover:text-gray-600">
                                &#129504; Razonamiento del LLM
                            </summary>
                            <p class="px-3 pb-2 text-gray-500">{{ email.reasoning }}</p>
                        </details>
                        {% endif %}

                        <div class="flex items-center gap-3 justify-between">
                            <button hx-post="/api/email/generate"
                                    hx-target="#email-area"
                                    hx-indicator="#regenerate-loading"
                                    hx-vals='js:{"research_data": JSON.stringify(researchData)}'
                                    hx-disabled-elt="this"
                                    class="px-5 py-2.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span>&#128260; Regenerar</span>
                                <div class="spinner htmx-indicator" id="regenerate-loading" style="border-top-color: #666"></div>
                            </button>
                            <button onclick="copyEmailToClipboard()"
                                    class="px-5 py-2.5 bg-faymex-red text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-2">
                                <span>&#128203; Copiar al Portapapeles</span>
                            </button>
                        </div>
                    </div>
                </div>

                <textarea id="email-plain-text" class="hidden">{{ email.body_text }}</textarea>
                {% else %}
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-faymex-dark to-gray-800 px-5 py-3">
                        <h2 class="text-white font-semibold">&#128231; Email SMTYKM</h2>
                    </div>
                    <div class="p-8 text-center">
                        <p class="text-gray-500 mb-4">No se pudo generar el email automaticamente</p>
                        <button hx-post="/api/email/generate"
                                hx-target="#email-area"
                                hx-indicator="#email-loading"
                                hx-vals='js:{"research_data": JSON.stringify(researchData)}'
                                class="px-6 py-2.5 bg-faymex-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium text-sm flex items-center gap-2 mx-auto disabled:opacity-50 disabled:cursor-not-allowed"
                                hx-disabled-elt="this">
                            <span>&#128231; Generar Email</span>
                            <div class="spinner htmx-indicator" id="email-loading"></div>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT COLUMN: Info Empresa -->
        <div class="lg:col-span-3 space-y-4">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-faymex-dark px-5 py-3">
                    <h3 class="text-white font-medium">&#127970; Info Empresa</h3>
                </div>
                <div class="p-5 space-y-3">
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Empresa</span>
                        <p class="font-semibold text-faymex-dark text-base">{{ result.empresa.get('nombre', company) }}</p>
                    </div>
                    {% if result.empresa.get('sitio_web') %}
                    <div>
                        <a href="{{ result.empresa.sitio_web }}" target="_blank" rel="noopener"
                           class="text-blue-600 hover:underline text-sm flex items-center gap-1">
                            &#127760; {{ result.empresa.sitio_web }}
                        </a>
                    </div>
                    {% endif %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Industria</span>
                        <div class="flex items-center gap-1.5">
                            <p class="font-medium text-sm">{{ result.empresa.get('industria', 'No identificada') }}</p>
                            {% if result.raw_sources and result.empresa.get('industria') %}
                                <span class="badge-verified">&#9989;</span>
                            {% elif result.empresa.get('industria') %}
                                <span class="badge-partial">&#9888;&#65039;</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if result.empresa.get('productos_servicios') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Productos / Servicios</span>
                        {% if result.empresa.productos_servicios is string %}
                            <p class="text-gray-700 text-sm">{{ result.empresa.productos_servicios }}</p>
                        {% else %}
                            {% for ps in result.empresa.productos_servicios %}
                            <p class="text-gray-700 text-sm">&#8226; {{ ps }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if result.empresa.get('tamaño') or result.empresa.get('tamano_empleados') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Tamano</span>
                        <p class="text-gray-700 text-sm">{{ result.empresa.get('tamaño', result.empresa.get('tamano_empleados', '')) }}</p>
                    </div>
                    {% endif %}
                    {% if result.empresa.get('noticias_recientes') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Noticias recientes</span>
                        {% if result.empresa.noticias_recientes is string %}
                            <p class="text-gray-700 text-sm">{{ result.empresa.noticias_recientes }}</p>
                        {% else %}
                            {% for noticia in result.empresa.noticias_recientes %}
                            <p class="text-gray-700 text-sm">&#8226; {{ noticia }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if result.empresa.get('desafios_sector') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Desafios del sector</span>
                        {% if result.empresa.desafios_sector is string %}
                            <p class="text-gray-700 text-sm">{{ result.empresa.desafios_sector }}</p>
                        {% else %}
                            {% for desafio in result.empresa.desafios_sector %}
                            <p class="text-gray-700 text-sm">&#8226; {{ desafio }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if result.empresa.get('competidores') %}
                    <div>
                        <span class="text-gray-400 text-xs uppercase tracking-wide">Competidores</span>
                        {% if result.empresa.competidores is string %}
                            <p class="text-gray-700 text-sm">{{ result.empresa.competidores }}</p>
                        {% else %}
                            {% for comp in result.empresa.competidores %}
                            <p class="text-gray-700 text-sm">&#8226; {{ comp }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% set empresa_sources = result.raw_sources | rejectattr('source', 'in', ['linkedin', 'perplexity_persona', 'duckduckgo']) | list %}
            {% if empresa_sources %}
            <details class="text-sm bg-white rounded-xl shadow-sm overflow-hidden">
                <summary class="px-5 py-3 text-gray-400 cursor-pointer hover:text-gray-600 font-medium">
                    &#127970; {{ empresa_sources | length }} fuentes empresa
                </summary>
                <div class="px-5 pb-3 space-y-1">
                    {% for src in empresa_sources[:10] %}
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <span class="w-20 text-gray-400 shrink-0 text-xs">{{ src.get('source', '') }}</span>
                        <a href="{{ src.get('url', '#') }}" target="_blank" rel="noopener"
                           class="text-blue-500 hover:underline truncate">
                            {{ src.get('title', src.get('url', '')) | truncate(40) }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>

    </div>

    <!-- Boton Nueva Investigacion (fondo) -->
    <div class="mt-6 flex justify-center">
        <button type="button" onclick="resetPage()"
                class="px-6 py-2.5 border-2 border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm flex items-center gap-2">
            <span>&#128260; Nueva Investigacion</span>
        </button>
    </div>
</div>

<script>
    {% if email %}
    initQuillEditor('quill-editor', `{{ email.body_html | safe }}`);
    updateStepIndicator(3);
    var subjectInput = document.getElementById('email-subject');
    if (subjectInput) updateSubjectCounter(subjectInput);
    showToast('Investigacion + email completados - Score: {{ result.score }}/100', 'success');
    {% else %}
    updateStepIndicator(2);
    showToast('Investigacion completada - Score: {{ result.score }}/100', 'success');
    {% endif %}
</script>
